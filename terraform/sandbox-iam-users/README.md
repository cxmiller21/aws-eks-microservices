# Terraform Cross-Account IAM Role and Policy

Assumes `./terraform/eks` resources are created in `sandbox-account-a`. These IAM resources will allow a user in another AWS Account `sandbox-account-x` for example to assume this role and locally run Terraform commands to modify or deploy resources in `sandbox-account-a`.

## IAM Restrictions

The IAM policies in this folder are aimed to provide the least amount of permissions needed to assume the role and deploy resources in the primary sandbox account. The restrictions are primarily focused by limiting permissions to resources prefixed `aws-eks-demo`. Resources without this prefix should not allowed to be modified or deployed.

## Apply in Primary Account

```bash
terraform init
terraform plan
terraform apply
```

After the resources are created, the following steps need to be completed manually:

1. Login to the AWS console and verify the users were created
2. For each user, enable console login access and share the details with the user
   1. Enable console login access
   2. Use an autogenerated password
   3. Check that the user must create a new password at next sign-in

## Destroy in Primary Account

```bash
terraform destroy
```

## Steps to follow in a Secondary AWS Sandbox Account

### Pre-requisites

- AWS IAM User configured with CLI access

1. Create a new IAM policy named: `AwsEksDemoSandboxCrossAccountAccessPolicy`
2. Add the new policy to the IAM user with CLI access
   ```json
   {
     "Version": "2012-10-17",
     "Statement": {
       "Effect": "Allow",
       "Action": "sts:AssumeRole",
       "Resource": "arn:aws:iam::<primary-sandbox-account-id>:role/eks-demo-cross-account-role"
     }
   }
   ```
3. Add a new AWS profile locally in `~/.aws/credentials`
   ```text
   [profile aws-eks-demo]
   region = us-east-1
   account = <primary-sandbox-account-id>
   role_arn = arn:aws:iam::<primary-sandbox-account-id>:role/eks-demo-cross-account-role
   source_profile = default
   output = json
   ```
4. From the project root, go to `./terraform/eks` and run `terraform init` and `terraform plan` to verify you can assume the role and deploy resources in the primary sandbox account
